meta {
  name: ExternalTest
  type: http
  seq: 3
}

post {
  url: https://test-api.service.hmrc.gov.uk/oauth/token
  body: formUrlEncoded
  auth: none
}

headers {
  content-type: application/x-www-form-urlencoded
}

body:form-urlencoded {
  client_secret: {{totp}}{{client_secret}}
  client_id: {{client_id}}
  grant_type: client_credentials
  scope: {{scope}}
}

script:pre-request {
  if (bru.getEnvVar("ENVIRONMENT") !== 'externaltest') {
    throw new Error('Environment must be set to ExternalTest');
  }

  let TOTP;
  try {
    TOTP = require("totp-generator").TOTP;
  } catch (e) {
    throw new Error("Missing dependency: totp-generator\nRun 'npm install' in the collection folder. See README for details.");
  }

  const totpSecret = bru.getEnvVar("TOTP_SECRET");

  if (!totpSecret) {
    throw new Error("TOTP_SECRET not set in environment variables");
  }

  const { otp } = await TOTP.generate(totpSecret, { digits: 8, algorithm: "SHA-512" });

  bru.setEnvVar("totp", otp);
}

script:post-response {
  if (res.status === 200) {
    console.log("FULL RESPONSE:");
    console.log(JSON.stringify(res.body, null, 2));
    const authToken = `Bearer ${res.body.access_token}`;
    bru.setEnvVar('authorization', authToken);
  } else {
    throw new Error('Authentication failed: ' + res.status);
  }
}
