meta {
  name: Expired Token
  type: http
  seq: 3
  tags: [
    AUTH
  ]
}

post {
  url: {{api-host}}/notification
  body: json
  auth: none
}

headers {
  Authorization: {{expiredToken}}
  Content-Type: application/json
  correlationId: {{correlationId}}
  gov-uk-originator-id: {{govUkOriginatorId}}
}

body:json {
  {
    "nationalInsuranceNumber": "{{nino}}",
    "universalCreditRecordType": "{{universalCreditRecordType}}",
    "universalCreditAction": "Insert",
    "dateOfBirth": "2002-04-27",
    "liabilityStartDate": "2025-08-19"
  }
}

script:pre-request {
  const expiredToken = bru.getEnvVar('expiredToken');

  if (!expiredToken) {
    throw new Error("Prerequisite Missing: Run 'Auth/Local - Expired Token' first.");
  }

  // Synchronous blocking delay - wait for token to expire
  const start = Date.now();
  while (Date.now() - start < 2000) {}
}

assert {
  res.status: eq 401
  res.headers.correlationid: eq {{correlationId}}
  res.body.code: eq 'UNAUTHORIZED'
  res.body.message: eq 'Session record not found'
}
